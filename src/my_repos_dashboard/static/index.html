<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Worktree Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Berkeley+Mono:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:        #0a0b0d;
      --surface:   #111318;
      --surface2:  #181c24;
      --surface3:  #1e2535;
      --border:    #1f2535;
      --border2:   #2a3148;
      --text:      #c8cfe0;
      --muted:     #4a5470;
      --accent:    #4f8ef7;
      --green:     #3ecf8e;
      --yellow:    #f5c842;
      --pink:      #f6adbd;
      --red:       #f25f5c;
      --purple:    #a78bfa;
      --cyan:      #22d3ee;
      --mono:      'Berkeley Mono', 'Fira Code', monospace;
      --sans:      'DM Sans', sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      min-height: 100vh;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 40px 40px;
      opacity: 0.22;
      pointer-events: none;
      z-index: 0;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      position: relative; z-index: 10;
      display: flex; align-items: center; justify-content: space-between;
      padding: 26px 40px 22px;
      border-bottom: 1px solid var(--border);
    }
    .logo { display: flex; align-items: center; gap: 14px; }
    .logo-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .logo-text { font-family: var(--mono); font-size: 1rem; color: #fff; letter-spacing: -0.02em; }
    .logo-sub  { font-family: var(--mono); font-size: 0.65rem; color: var(--muted); margin-top: 1px; }
    .header-right { display: flex; align-items: center; gap: 12px; }
    .stats-pill {
      font-family: var(--mono); font-size: 0.7rem;
      color: var(--muted); background: var(--surface);
      border: 1px solid var(--border); border-radius: 20px;
      padding: 5px 14px; display: flex; gap: 14px;
    }
    .stats-pill span { color: var(--text); }
    .search-wrap { position: relative; display: flex; align-items: center; }
    .search-wrap svg { position: absolute; left: 10px; opacity: 0.4; pointer-events: none; }
    #search {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; padding: 7px 14px 7px 34px;
      color: var(--text); font-family: var(--mono); font-size: 0.78rem;
      width: 200px; outline: none; transition: border-color 0.2s;
    }
    #search:focus { border-color: var(--accent); }
    .icon-btn {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 8px; padding: 7px 13px; color: var(--muted);
      font-family: var(--mono); font-size: 0.75rem; cursor: pointer;
      transition: all 0.2s; display: flex; align-items: center; gap: 6px;
    }
    .icon-btn:hover { border-color: var(--accent); color: var(--accent); }
    .icon-btn.spinning svg { animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
    .filter-bar {
      position: relative; z-index: 10;
      display: flex; align-items: center; gap: 8px;
      padding: 12px 40px; border-bottom: 1px solid var(--border);
    }
    .filter-label { font-family: var(--mono); font-size: 0.65rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-right: 4px; }
    .filter-btn {
      font-family: var(--mono); font-size: 0.7rem; padding: 4px 12px;
      border-radius: 5px; border: 1px solid var(--border);
      background: transparent; color: var(--muted); cursor: pointer; transition: all 0.15s;
    }
    .filter-btn:hover { background: var(--surface2); border-color: var(--border2); color: var(--text); }
    .filter-btn.active { color: var(--accent); border-color: var(--accent); background: rgba(79,142,247,0.06); }

    /* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
    main { position: relative; z-index: 5; padding: 28px 40px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; }

    /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
    .card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; overflow: hidden;
      transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
      animation: fadeUp 0.35s ease both;
    }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(14px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .card:hover { transform: translateY(-3px); border-color: var(--border2); box-shadow: 0 10px 36px rgba(0,0,0,0.5); }
    .card-status-bar { height: 3px; width: 100%; }
    .status-clean .card-status-bar { background: var(--green); }
    .status-dirty .card-status-bar { background: linear-gradient(90deg, var(--yellow), var(--red)); }
    .status-nogit .card-status-bar { background: var(--border2); }
    .card-body { padding: 15px 17px 13px; }
    .card-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; margin-bottom: 9px; }
    .repo-name { font-family: var(--mono); font-size: 0.9rem; color: #fff; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .badge-row { display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end; flex-shrink: 0; }
    .badge { font-family: var(--mono); font-size: 0.58rem; padding: 2px 7px; border-radius: 4px; font-weight: 700; white-space: nowrap; }
    .badge-branch  { background: rgba(79,142,247,0.12);  color: var(--accent);  border: 1px solid rgba(79,142,247,0.25); }
    .badge-dirty   { background: rgba(245,200,66,0.1);   color: var(--yellow);  border: 1px solid rgba(245,200,66,0.25); }
    .badge-clean   { background: rgba(62,207,142,0.1);   color: var(--green);   border: 1px solid rgba(62,207,142,0.25); }
    .badge-ahead   { background: rgba(167,139,250,0.1);  color: var(--purple);  border: 1px solid rgba(167,139,250,0.25); }
    .badge-behind  { background: rgba(242,95,92,0.1);    color: var(--red);     border: 1px solid rgba(242,95,92,0.25); }
    .badge-stash   { background: rgba(79,142,247,0.07);  color: var(--muted);   border: 1px solid var(--border2); }
    .commit-line { display: flex; align-items: center; gap: 8px; font-family: var(--mono); font-size: 0.67rem; color: var(--muted); margin-bottom: 11px; min-height: 18px; }
    .commit-hash { color: var(--border2); flex-shrink: 0; }
    .commit-msg  { color: var(--text); opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .commit-time { flex-shrink: 0; margin-left: auto; }
    .diff-stats  { display: flex; gap: 10px; margin-bottom: 11px; font-family: var(--mono); font-size: 0.64rem; }
    .diff-item   { display: flex; align-items: center; gap: 4px; }
    .diff-dot    { width: 6px; height: 6px; border-radius: 50%; }
    .diff-staged    .diff-dot { background: var(--green); }
    .diff-unstaged  .diff-dot { background: var(--yellow); }
    .diff-untracked .diff-dot { background: var(--muted); }
    .diff-label { color: var(--muted); }
    .diff-count { color: var(--text); }

    /* Compact worktree preview in card */
    .wt-preview {
      border-top: 1px solid var(--border);
      margin-top: 10px; padding-top: 9px;
    }
    .wt-preview-row {
      display: flex; align-items: center; gap: 7px;
      font-family: var(--mono); font-size: 0.65rem;
      color: var(--muted); margin-bottom: 3px;
    }
    .wt-preview-branch { color: var(--accent); }
    .wt-status-dot {
      width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
    }
    .wt-s-FRESH      { background: var(--cyan); }
    .wt-s-MERGED     { background: var(--green); }
    .wt-s-NOT-MERGED { background: var(--yellow); }
    .wt-s-DETACHED   { background: var(--red); }
    .wt-s-NA         { background: var(--muted); }
    .wt-more { font-family: var(--mono); font-size: 0.6rem; color: var(--muted); margin-top: 2px; }

    /* Card actions */
    .card-actions { display: flex; gap: 6px; margin-top: 12px; }
    .action-btn {
      flex: 1; padding: 6px 8px; border-radius: 7px;
      border: 1px solid var(--border); background: var(--surface2);
      color: var(--muted); font-family: var(--mono); font-size: 0.67rem;
      cursor: pointer; transition: all 0.15s;
      display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    .action-btn:hover { border-color: var(--border2); color: var(--text); background: var(--surface3); }
    .action-btn.primary { border-color: rgba(79,142,247,0.3); color: var(--accent); }
    .action-btn.primary:hover { background: rgba(79,142,247,0.1); border-color: var(--accent); }
    .action-btn.wt-btn { border-color: rgba(167,139,250,0.3); color: var(--purple); }
    .action-btn.wt-btn:hover { background: rgba(167,139,250,0.1); border-color: var(--purple); }
    .action-btn.git-btn { border-color: rgba(62,207,142,0.3); color: var(--green); }
    .action-btn.git-btn:hover { background: rgba(62,207,142,0.1); border-color: var(--green); }
    .action-btn.scratchpad-btn { border-color: rgba(251,191,36,0.3); color: var(--yellow); }
    .action-btn.scratchpad-btn:hover { background: rgba(251,191,36,0.1); border-color: var(--yellow); }
    .action-btn-wrapper { position: relative; }
    .card-icon-row { display: flex; gap: 10px; margin-top: 8px; align-items: center; }
    .card-icon-wrapper { position: relative; display: inline-flex; }
    .card-icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      color: var(--muted);
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.15s, background 0.15s;
    }
    .card-icon-btn:hover { background: var(--surface3); }
    .card-icon-btn.notes-icon:hover { color: var(--yellow); }

    /* Scratchpad indicator dot */
    .scratchpad-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--yellow);
      position: absolute; top: -2px; right: -2px;
    }

    /* Scratchpad modal */
    .scratchpad-modal {
      background: var(--surface); border: 1px solid var(--border2);
      border-radius: 16px; width: 600px; max-width: 95vw;
      max-height: 80vh; display: flex; flex-direction: column;
      box-shadow: 0 24px 80px rgba(0,0,0,0.7);
      animation: modalIn 0.25s cubic-bezier(0.4,0,0.2,1);
    }
    .scratchpad-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 18px 22px; border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    .scratchpad-header h3 {
      font-family: var(--mono); font-size: 0.85rem; color: #fff;
    }
    .scratchpad-header .close-btn {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 7px; color: var(--muted); width: 28px; height: 28px;
      cursor: pointer; font-size: 0.9rem; transition: all 0.15s;
      display: flex; align-items: center; justify-content: center;
    }
    .scratchpad-header .close-btn:hover { color: #fff; border-color: var(--border2); }
    #scratchpad-textarea {
      flex: 1; min-height: 300px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 8px; padding: 12px;
      color: var(--text); font-family: var(--mono); font-size: 0.85rem;
      resize: none; outline: none; margin: 20px 22px;
    }
    #scratchpad-textarea:focus { border-color: var(--accent); }
    .scratchpad-footer {
      padding: 0 22px 20px; display: flex; justify-content: flex-end;
    }
    .action-btn.primary { border-color: rgba(79,142,247,0.3); color: var(--accent); background: rgba(79,142,247,0.08); }
    .action-btn.primary:hover { background: rgba(79,142,247,0.15); border-color: var(--accent); }

    /* ‚îÄ‚îÄ WORKTREE MANAGER MODAL ‚îÄ‚îÄ */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
      z-index: 500; align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }

    .wt-modal {
      background: var(--surface); border: 1px solid var(--border2);
      border-radius: 16px; width: 780px; max-width: 95vw;
      max-height: 88vh; display: flex; flex-direction: column;
      box-shadow: 0 24px 80px rgba(0,0,0,0.7);
      animation: modalIn 0.25s cubic-bezier(0.4,0,0.2,1);
    }
    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95) translateY(20px); }
      to   { opacity: 1; transform: scale(1) translateY(0); }
    }

    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 18px 22px; border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    .modal-title-wrap { display: flex; align-items: center; gap: 12px; }
    .modal-icon {
      width: 30px; height: 30px; border-radius: 7px;
      background: linear-gradient(135deg, rgba(167,139,250,0.3), rgba(79,142,247,0.3));
      display: flex; align-items: center; justify-content: center; font-size: 14px;
    }
    .modal-title { font-family: var(--mono); font-size: 0.85rem; color: #fff; }
    .modal-subtitle { font-family: var(--mono); font-size: 0.65rem; color: var(--muted); margin-top: 1px; }
    .modal-close {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 7px; color: var(--muted); width: 28px; height: 28px;
      cursor: pointer; font-size: 0.9rem; transition: all 0.15s;
      display: flex; align-items: center; justify-content: center;
    }
    .modal-close:hover { color: #fff; border-color: var(--border2); }

    .modal-body { flex: 1; overflow-y: auto; padding: 20px 22px; }

    /* Parent branch context bar */
    .context-bar {
      display: flex; align-items: center; gap: 10px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 8px; padding: 10px 14px; margin-bottom: 18px;
      font-family: var(--mono); font-size: 0.72rem;
    }
    .context-label { color: var(--muted); }
    .context-branch { color: var(--green); font-weight: 700; }
    .context-sha { color: var(--muted); }

    /* Create form */
    .create-section {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 10px; padding: 15px 16px; margin-bottom: 18px;
    }
    .create-header {
      font-family: var(--mono); font-size: 0.65rem; color: var(--muted);
      text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 10px;
    }
    .create-row { display: flex; gap: 8px; align-items: center; }
    .create-input {
      flex: 1; background: var(--surface); border: 1px solid var(--border);
      border-radius: 7px; padding: 8px 12px;
      color: var(--text); font-family: var(--mono); font-size: 0.78rem;
      outline: none; transition: border-color 0.2s;
    }
    .create-input:focus { border-color: var(--purple); }
    .create-btn {
      background: rgba(167,139,250,0.15); border: 1px solid rgba(167,139,250,0.35);
      border-radius: 7px; padding: 8px 16px; color: var(--purple);
      font-family: var(--mono); font-size: 0.75rem; font-weight: 700;
      cursor: pointer; transition: all 0.15s; white-space: nowrap;
      display: flex; align-items: center; gap: 6px;
    }
    .create-btn:hover { background: rgba(167,139,250,0.25); border-color: var(--purple); }
    .create-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .create-hint { font-family: var(--mono); font-size: 0.62rem; color: var(--muted); margin-top: 7px; }

    /* Worktree table */
    .wt-section-label {
      font-family: var(--mono); font-size: 0.65rem; color: var(--muted);
      text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 10px;
    }
    .wt-table { width: 100%; border-collapse: collapse; }
    .wt-table th {
      font-family: var(--mono); font-size: 0.62rem; color: var(--muted);
      text-transform: uppercase; letter-spacing: 0.08em;
      text-align: left; padding: 0 10px 8px;
      border-bottom: 1px solid var(--border);
    }
    .wt-row {
      border-bottom: 1px solid var(--border);
      transition: background 0.1s;
    }
    .wt-row:last-child { border-bottom: none; }
    .wt-row:hover { background: var(--surface2); }
    .wt-row.is-main { opacity: 0.6; }
    .wt-cell {
      padding: 10px 10px; vertical-align: middle;
      font-family: var(--mono); font-size: 0.72rem;
    }
    .wt-cell-branch { color: var(--accent); font-weight: 700; }
    .wt-cell-path   { color: var(--muted); font-size: 0.64rem; }
    .wt-cell-sha    { color: var(--border2); }
    .wt-cell-age    { color: var(--muted); text-align: right; }

    /* Status badge in table */
    .wt-status {
      display: inline-flex; align-items: center; gap: 5px;
      font-family: var(--mono); font-size: 0.62rem;
      padding: 2px 8px; border-radius: 4px; font-weight: 700;
    }
    .wt-status-dot-sm { width: 5px; height: 5px; border-radius: 50%; }
    .s-FRESH      { background: rgba(34,211,238,0.1);  color: var(--cyan);   border: 1px solid rgba(34,211,238,0.25); }
    .s-MERGED     { background: rgba(62,207,142,0.1);  color: var(--green);  border: 1px solid rgba(62,207,142,0.25); }
    .s-NOT-MERGED { background: rgba(245,200,66,0.1);  color: var(--yellow); border: 1px solid rgba(245,200,66,0.25); }
    .s-DETACHED   { background: rgba(242,95,92,0.1);   color: var(--red);    border: 1px solid rgba(242,95,92,0.25); }
    .s-NA         { background: rgba(74,84,112,0.1);   color: var(--muted);  border: 1px solid var(--border); }
    .s-ERROR      { background: rgba(242,95,92,0.1);   color: var(--red);    border: 1px solid rgba(242,95,92,0.25); }
    .dot-FRESH      { background: var(--cyan); }
    .dot-MERGED     { background: var(--green); }
    .dot-NOT-MERGED { background: var(--yellow); }
    .dot-DETACHED   { background: var(--red); }
    .dot-NA         { background: var(--muted); }
    .dot-ERROR      { background: var(--red); }

    /* Action cell in table */
    .wt-actions-cell { display: flex; gap: 5px; justify-content: flex-end; }
    .wt-action {
      background: transparent; border: 1px solid var(--border);
      border-radius: 5px; padding: 3px 10px;
      font-family: var(--mono); font-size: 0.63rem; color: var(--muted);
      cursor: pointer; transition: all 0.15s; white-space: nowrap;
    }
    .wt-action:hover          { border-color: var(--border2); color: var(--text); background: var(--surface3); }
    .wt-action.wt-open:hover  { border-color: var(--accent); color: var(--accent); }
    .wt-action.wt-merge:hover { border-color: var(--green);  color: var(--green); }
    .wt-action.wt-del:hover   { border-color: var(--red);    color: var(--red); }

    /* Merge / remove confirm panels */
    .confirm-panel {
      background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 10px; padding: 16px 18px; margin-top: 16px;
    }
    .confirm-title { font-family: var(--mono); font-size: 0.8rem; color: #fff; margin-bottom: 10px; }
    .confirm-detail { font-family: var(--mono); font-size: 0.7rem; color: var(--muted); margin-bottom: 14px; line-height: 1.6; }
    .confirm-detail strong { color: var(--text); }
    .confirm-warn { color: var(--yellow); font-size: 0.68rem; font-family: var(--mono); margin-bottom: 12px; }
    .checkbox-row { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; font-family: var(--mono); font-size: 0.72rem; color: var(--muted); cursor: pointer; }
    .checkbox-row input { accent-color: var(--purple); cursor: pointer; }
    .confirm-btns { display: flex; gap: 8px; }
    .btn-confirm {
      padding: 7px 18px; border-radius: 7px; font-family: var(--mono);
      font-size: 0.73rem; font-weight: 700; cursor: pointer; transition: all 0.15s;
    }
    .btn-cancel  { background: var(--surface3); border: 1px solid var(--border2); color: var(--muted); }
    .btn-cancel:hover { color: var(--text); }
    .btn-danger  { background: rgba(242,95,92,0.15); border: 1px solid rgba(242,95,92,0.35); color: var(--red); }
    .btn-danger:hover { background: rgba(242,95,92,0.25); }
    .btn-success { background: rgba(62,207,142,0.15); border: 1px solid rgba(62,207,142,0.35); color: var(--green); }
    .btn-success:hover { background: rgba(62,207,142,0.25); }

    /* Empty state */
    .wt-empty { text-align: center; padding: 32px; font-family: var(--mono); font-size: 0.75rem; color: var(--muted); }

    /* Loading row */
    .wt-loading { display: flex; align-items: center; gap: 10px; padding: 24px 0; font-family: var(--mono); font-size: 0.75rem; color: var(--muted); justify-content: center; }

    /* Git Actions Grid */
    .git-actions-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .git-action-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      text-align: center;
    }
    .git-action-card:hover {
      background: var(--surface3);
      border-color: var(--border2);
      transform: translateY(-2px);
    }
    .git-action-card.danger:hover {
      border-color: rgba(242,95,92,0.5);
      background: rgba(242,95,92,0.08);
    }
    .git-icon {
      width: 40px; height: 40px;
      border-radius: 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      color: var(--muted);
    }
    .git-action-card:hover .git-icon {
      color: var(--text);
      border-color: var(--border2);
    }
    .git-action-card.danger:hover .git-icon {
      color: var(--red);
      border-color: rgba(242,95,92,0.4);
      background: rgba(242,95,92,0.1);
    }
    .git-label {
      font-family: var(--mono);
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
    }
    .git-desc {
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--muted);
    }
    .git-history-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      font-family: var(--mono);
      font-size: 0.7rem;
    }
    .git-history-item:last-child { border-bottom: none; }
    .git-history-item:hover { background: var(--surface2); }
    .git-hash { color: var(--accent); font-weight: 700; flex-shrink: 0; }
    .git-msg { color: var(--text); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .git-meta { color: var(--muted); font-size: 0.65rem; flex-shrink: 0; }

    /* ‚îÄ‚îÄ STATS MODAL ‚îÄ‚îÄ */
    .stats-loading { display: flex; align-items: center; gap: 10px; justify-content: center; padding: 40px; color: var(--muted); font-family: var(--mono); font-size: 0.75rem; }
    .stats-section { margin-bottom: 20px; }
    .stats-section-title { font-family: var(--mono); font-size: 0.63rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 9px; }
    .streak-hero { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .streak-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; }
    .streak-card.active { border-color: rgba(62,207,142,0.35); background: rgba(62,207,142,0.04); }
    .streak-num { font-family: var(--mono); font-size: 2.2rem; font-weight: 700; line-height: 1; color: #fff; margin-bottom: 4px; }
    .streak-card.active .streak-num { color: var(--green); }
    .streak-label { font-family: var(--mono); font-size: 0.63rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
    .streak-sub { font-family: var(--mono); font-size: 0.6rem; color: var(--muted); margin-top: 3px; }
    .health-bar { display: flex; align-items: center; gap: 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; margin-bottom: 20px; font-family: var(--mono); font-size: 0.7rem; }
    .health-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .health-dot.warn { background: var(--yellow); box-shadow: 0 0 5px rgba(245,200,66,0.5); }
    .health-dot.ok   { background: var(--green);  box-shadow: 0 0 5px rgba(62,207,142,0.5); }
    .health-text { color: var(--text); flex: 1; }
    .health-detail { color: var(--muted); font-size: 0.62rem; }
    .insight-row { display: flex; align-items: center; gap: 12px; padding: 9px 13px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 6px; font-family: var(--mono); font-size: 0.72rem; }
    .insight-row:last-child { margin-bottom: 0; }
    .insight-label { color: var(--muted); min-width: 130px; }
    .insight-value { color: var(--text); font-weight: 600; }
    .insight-highlight { color: var(--green); }
    .week-chart-wrap { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 12px 12px 6px; }
    .week-legend { display: flex; gap: 14px; margin-bottom: 10px; font-family: var(--mono); font-size: 0.6rem; color: var(--muted); }
    .legend-swatch { display: inline-block; width: 8px; height: 8px; border-radius: 2px; margin-right: 4px; vertical-align: middle; }
    .week-chart { display: flex; gap: 5px; align-items: flex-end; height: 72px; }
    .week-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .week-bars { display: flex; gap: 2px; align-items: flex-end; height: 56px; }
    .week-bar { width: 9px; border-radius: 2px 2px 0 0; min-height: 2px; position: relative; transition: opacity 0.15s; }
    .week-bar:hover { opacity: 0.75; }
    .week-bar:hover::after { content: attr(data-tip); position: absolute; bottom: calc(100% + 4px); left: 50%; transform: translateX(-50%); background: var(--surface3); border: 1px solid var(--border2); padding: 2px 6px; border-radius: 4px; font-family: var(--mono); font-size: 0.58rem; color: var(--text); white-space: nowrap; pointer-events: none; z-index: 20; }
    .week-bar.this { background: var(--accent); }
    .week-bar.last { background: var(--border2); }
    .week-day-label { font-family: var(--mono); font-size: 0.52rem; color: var(--muted); }
    .hour-wrap { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 12px 10px 8px; }
    .hour-grid { display: grid; grid-template-columns: repeat(24,1fr); gap: 3px; margin-bottom: 4px; }
    .hour-cell { height: 20px; border-radius: 3px; position: relative; transition: transform 0.1s; cursor: default; }
    .hour-cell:hover { transform: scaleY(1.2); z-index: 2; }
    .hour-cell:hover::after { content: attr(data-tip); position: absolute; bottom: calc(100% + 4px); left: 50%; transform: translateX(-50%); background: var(--surface3); border: 1px solid var(--border2); padding: 2px 6px; border-radius: 4px; font-family: var(--mono); font-size: 0.58rem; color: var(--text); white-space: nowrap; pointer-events: none; z-index: 20; }
    .hour-labels { display: grid; grid-template-columns: repeat(24,1fr); gap: 3px; }
    .hour-label { font-family: var(--mono); font-size: 0.45rem; color: var(--muted); text-align: center; }
    .activity-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 6px; overflow: hidden; }
    .activity-item:last-child { margin-bottom: 0; }
    .activity-main { display: flex; align-items: center; gap: 10px; padding: 9px 12px; font-family: var(--mono); font-size: 0.72rem; }
    .activity-name { color: var(--text); flex: 1; font-weight: 600; }
    .activity-bar-wrap { display: flex; align-items: center; gap: 7px; flex: 1; max-width: 160px; }
    .activity-bar { height: 5px; background: var(--surface); border-radius: 3px; flex: 1; overflow: hidden; }
    .activity-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--purple)); border-radius: 3px; }
    .activity-count { color: var(--muted); font-size: 0.67rem; min-width: 28px; text-align: right; }
    .repo-spark { display: flex; align-items: flex-end; gap: 2px; height: 16px; padding: 0 12px 7px; }
    .spark-b { flex: 1; border-radius: 1px 1px 0 0; min-height: 2px; }
    .spark-b.on { background: rgba(79,142,247,0.55); }
    .spark-b.off { background: var(--border); }

    /* ‚îÄ‚îÄ RECENT FILES TOOLTIP ‚îÄ‚îÄ */
    .commit-line { position: relative; }
    .recent-files-trigger {
      cursor: pointer;
      border-radius: 3px;
      padding: 1px 3px;
      transition: background 0.15s;
    }
    .recent-files-trigger:hover { background: var(--surface3); }

    .files-tooltip {
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      z-index: 1000;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: 9px;
      padding: 10px 0;
      min-width: 280px;
      max-width: 360px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      animation: tooltipIn 0.15s ease;
      box-sizing: border-box;
      scrollbar-gutter: stable;
    }
    .files-tooltip ul, 
    .files-tooltip div {
      padding-bottom: 10px; 
      margin: 0;
    }
    @keyframes tooltipIn {
      from { opacity:0; transform:translateY(-4px); }
      to   { opacity:1; transform:translateY(0); }
    }
    .files-tooltip.visible { display: block; }
    .tooltip-header {
      font-family: var(--mono); font-size: 0.6rem; color: var(--muted);
      text-transform: uppercase; letter-spacing: 0.1em;
      padding: 0 12px 8px; border-bottom: 1px solid var(--border);
      margin-bottom: 6px;
    }
    .file-row {
      display: flex; align-items: center; gap: 8px;
      padding: 3px 12px; font-family: var(--mono); font-size: 0.67rem;
    }
    .file-row:hover { background: var(--surface3); }
    .file-status {
      width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.55rem; font-weight: 700;
    }
    .fs-M { background: rgba(245,200,66,0.15);  color: var(--yellow); }
    .fs-A { background: rgba(62,207,142,0.15);  color: var(--green); }
    .fs-D { background: rgba(242,95,92,0.15);   color: var(--red); }
    .fs-R { background: rgba(79,142,247,0.15);  color: var(--accent); }
    .fs-  { background: rgba(74,84,112,0.15);   color: var(--muted); }
    .file-path { color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0; }
    .file-dir  { color: var(--muted); }
    .tooltip-loading { padding: 14px 12px; color: var(--muted); font-family: var(--mono); font-size: 0.7rem; display: flex; align-items: center; gap: 8px; }

    /* ‚îÄ‚îÄ COMMANDS PANEL ‚îÄ‚îÄ */
    .commands-section {
      border-top: 1px solid var(--border);
      margin-top: 10px; padding-top: 10px;
    }
    .commands-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 7px;
    }
    .commands-label {
      font-family: var(--mono); font-size: 0.6rem; color: var(--muted);
      text-transform: uppercase; letter-spacing: 0.1em;
    }
    .cmd-edit-toggle {
      font-family: var(--mono); font-size: 0.6rem; color: var(--muted);
      background: none; border: none; cursor: pointer; padding: 0;
      transition: color 0.15s;
    }
    .cmd-edit-toggle:hover { color: var(--text); }
    .cmd-run-row {
      display: flex; align-items: center; gap: 6px;
      margin-bottom: 5px;
    }
    .cmd-run-btn {
      flex: 1; display: flex; align-items: center; gap: 6px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 6px; padding: 5px 10px;
      font-family: var(--mono); font-size: 0.68rem; color: var(--text);
      cursor: pointer; transition: all 0.15s; text-align: left;
    }
    .cmd-run-btn:hover { border-color: var(--green); color: var(--green); background: rgba(62,207,142,0.06); }
    .cmd-run-btn.running { opacity: 0.6; cursor: not-allowed; }
    .cmd-play { color: var(--green); flex-shrink: 0; }
    .cmd-label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cmd-shell { color: var(--muted); font-size: 0.58rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }

    /* Edit mode */
    .cmd-edit-area { margin-top: 8px; }
    .cmd-edit-row {
      display: flex; gap: 5px; margin-bottom: 5px; align-items: center;
    }
    .cmd-input {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 5px; padding: 4px 8px;
      color: var(--text); font-family: var(--mono); font-size: 0.65rem;
      outline: none; transition: border-color 0.15s;
    }
    .cmd-input:focus { border-color: var(--accent); }
    .cmd-input-label { width: 80px; }
    .cmd-input-cmd   { flex: 1; }
    .cmd-del-btn {
      background: none; border: 1px solid var(--border);
      border-radius: 5px; padding: 4px 7px; color: var(--muted);
      font-family: var(--mono); font-size: 0.6rem; cursor: pointer;
      transition: all 0.15s; flex-shrink: 0;
    }
    .cmd-del-btn:hover { border-color: var(--red); color: var(--red); }
    .cmd-add-btn {
      background: none; border: 1px dashed var(--border2);
      border-radius: 5px; padding: 4px 10px; color: var(--muted);
      font-family: var(--mono); font-size: 0.62rem; cursor: pointer;
      width: 100%; margin-top: 4px; transition: all 0.15s;
    }
    .cmd-add-btn:hover { border-color: var(--accent); color: var(--accent); }
    .cmd-save-btn {
      background: rgba(62,207,142,0.12); border: 1px solid rgba(62,207,142,0.3);
      border-radius: 5px; padding: 4px 12px; color: var(--green);
      font-family: var(--mono); font-size: 0.62rem; font-weight: 700;
      cursor: pointer; width: 100%; margin-top: 6px; transition: all 0.15s;
    }
    .cmd-save-btn:hover { background: rgba(62,207,142,0.2); }

    /* Command output panel */
    .cmd-output-panel {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 7px; margin-top: 8px; overflow: hidden;
      display: none;
    }
    .cmd-output-panel.visible { display: block; }
    .cmd-output-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 5px 10px; background: var(--surface2);
      border-bottom: 1px solid var(--border);
      font-family: var(--mono); font-size: 0.6rem; color: var(--muted);
    }
    .cmd-output-close { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 0.7rem; }
    .cmd-output-close:hover { color: var(--text); }
    .cmd-output-body {
      padding: 8px 10px; font-family: var(--mono); font-size: 0.65rem;
      color: var(--text); white-space: pre-wrap; max-height: 120px;
      overflow-y: auto; line-height: 1.5;
    }
    .cmd-output-ok  { color: var(--green); }
    .cmd-output-err { color: var(--red); }

    /* ‚îÄ‚îÄ RECENT FILES TOOLTIP ‚îÄ‚îÄ */
    #readme-panel {
      position: fixed; top: 0; right: -680px; width: 660px; height: 100vh;
      background: var(--surface); border-left: 1px solid var(--border2);
      z-index: 600; display: flex; flex-direction: column;
      transition: right 0.32s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: -20px 0 60px rgba(0,0,0,0.6);
    }
    #readme-panel.open { right: 0; }
    .panel-header { display: flex; align-items: center; justify-content: space-between; padding: 18px 22px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .panel-title { font-family: var(--mono); font-size: 0.8rem; color: #fff; }
    #panel-close { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--muted); width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    #panel-close:hover { color: #fff; border-color: var(--border2); }
    #readme-content { flex: 1; overflow-y: auto; padding: 24px 26px; font-family: var(--sans); font-size: 0.87rem; line-height: 1.75; color: var(--text); }
    #readme-content h1, #readme-content h2, #readme-content h3 { font-family: var(--mono); color: #fff; margin: 1.4em 0 0.5em; font-weight: 700; }
    #readme-content h1 { font-size: 1.25rem; border-bottom: 1px solid var(--border); padding-bottom: 0.4em; }
    #readme-content h2 { font-size: 0.95rem; }
    #readme-content h3 { font-size: 0.82rem; color: var(--accent); }
    #readme-content code { font-family: var(--mono); background: var(--surface2); padding: 1px 6px; border-radius: 4px; font-size: 0.82em; color: var(--green); }
    #readme-content pre { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px; overflow-x: auto; margin: 1em 0; }
    #readme-content pre code { background: none; padding: 0; font-size: 0.79rem; color: var(--text); }
    #readme-content a { color: var(--accent); }
    #readme-content p { margin-bottom: 0.8em; }
    #readme-content ul, #readme-content ol { margin: 0.5em 0 0.8em 1.4em; }
    #readme-content li { margin-bottom: 0.2em; }
    #readme-content blockquote { border-left: 3px solid var(--border2); padding-left: 12px; color: var(--muted); margin: 1em 0; }
    #readme-content hr { border: none; border-top: 1px solid var(--border); margin: 1.4em 0; }

    /* ‚îÄ‚îÄ BACKDROP ‚îÄ‚îÄ */
    #backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 590; backdrop-filter: blur(2px); }
    #backdrop.show { display: block; }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toast {
      position: fixed; bottom: 28px; left: 50%;
      transform: translateX(-50%) translateY(16px);
      background: var(--surface2); border: 1px solid var(--border2);
      border-radius: 8px; padding: 9px 18px;
      font-family: var(--mono); font-size: 0.74rem; color: var(--text);
      z-index: 9999; opacity: 0; transition: all 0.22s; pointer-events: none;
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    #toast.ok  { border-color: rgba(62,207,142,0.4); color: var(--green); }
    #toast.err { border-color: rgba(242,95,92,0.4);  color: var(--red); }

    /* ‚îÄ‚îÄ LOADING / EMPTY ‚îÄ‚îÄ */
    .loading { grid-column: 1/-1; display: flex; align-items: center; justify-content: center; padding: 80px; font-family: var(--mono); color: var(--muted); font-size: 0.8rem; gap: 12px; }
    .spinner { width: 16px; height: 16px; border: 2px solid var(--border2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; }
    .empty { grid-column: 1/-1; text-align: center; padding: 80px; font-family: var(--mono); color: var(--muted); font-size: 0.8rem; }

    scrollbar-width: thin;
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">‚å•</div>
    <div>
      <div class="logo-text">worktree</div>
      <div class="logo-sub">local repo dashboard</div>
    </div>
  </div>
  <div class="header-right">
    <div class="stats-pill">
      <span id="stat-total">‚Äî</span> repos &nbsp;¬∑&nbsp;
      <span id="stat-dirty">‚Äî</span> dirty &nbsp;¬∑&nbsp;
      <span id="stat-wt">‚Äî</span> worktrees
    </div>
    <div class="search-wrap">
      <svg width="13" height="13" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="9" cy="9" r="6"/><line x1="13.5" y1="13.5" x2="18" y2="18"/></svg>
      <input id="search" type="text" placeholder="filter repos‚Ä¶" autocomplete="off">
    </div>
    <button class="icon-btn" id="refresh-btn" onclick="loadProjects()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
      refresh
    </button>
    <button class="icon-btn" onclick="openStatsModal()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
      stats
    </button>
  </div>
</header>

<div class="filter-bar">
  <span class="filter-label">filter</span>
  <button class="filter-btn active" data-filter="all">all</button>
  <button class="filter-btn" data-filter="dirty">dirty</button>
  <button class="filter-btn" data-filter="clean">clean</button>
  <button class="filter-btn" data-filter="worktrees">has worktrees</button>
  <button class="filter-btn" data-filter="nogit">no git</button>
</div>

<main>
  <div class="grid" id="grid">
    <div class="loading"><div class="spinner"></div> loading repos‚Ä¶</div>
  </div>
</main>

<!-- ‚îÄ‚îÄ WORKTREE MANAGER MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="wt-overlay" onclick="handleOverlayClick(event)">
  <div class="wt-modal" id="wt-modal">
    <div class="modal-header">
      <div class="modal-title-wrap">
        <div class="modal-icon">‚éá</div>
        <div>
          <div class="modal-title" id="wt-modal-title">Worktree Manager</div>
          <div class="modal-subtitle" id="wt-modal-sub">‚Äî</div>
        </div>
      </div>
      <button class="modal-close" onclick="closeWTModal()">‚úï</button>
    </div>
    <div class="modal-body" id="wt-modal-body">
      <div class="wt-loading"><div class="spinner"></div> loading worktrees‚Ä¶</div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ GIT ACTIONS MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="git-overlay" onclick="handleGitOverlayClick(event)">
  <div class="wt-modal" id="git-modal" style="width: 600px;">
    <div class="modal-header">
      <div class="modal-title-wrap">
        <div class="modal-icon" style="background: linear-gradient(135deg, rgba(62,207,142,0.3), rgba(34,211,238,0.3));"></div>
        <div>
          <div class="modal-title" id="git-modal-title">Git Actions</div>
          <div class="modal-subtitle" id="git-modal-sub">‚Äî</div>
        </div>
      </div>
      <button class="modal-close" onclick="closeGitModal()">‚úï</button>
    </div>
    <div class="modal-body" id="git-modal-body">
      <div class="git-actions-grid">
        <button class="git-action-card" onclick="gitModalAction('history')">
          <div class="git-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          </div>
          <div class="git-label">History</div>
          <div class="git-desc">View recent commits</div>
        </button>
        <button class="git-action-card" onclick="gitModalAction('branches')">
          <div class="git-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="6" y1="3" x2="6" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>
          </div>
          <div class="git-label">Branches</div>
          <div class="git-desc">View latest branches</div>
        </button>
        <button class="git-action-card" onclick="gitModalAction('pull')">
          <div class="git-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="8 17 12 21 16 17"/><line x1="12" y1="3" x2="12" y2="21"/></svg>
          </div>
          <div class="git-label">Pull</div>
          <div class="git-desc">git pull</div>
        </button>
        <button class="git-action-card danger" onclick="gitModalAction('reset')">
          <div class="git-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
          </div>
          <div class="git-label">Force Reset</div>
          <div class="git-desc">git reset --hard HEAD</div>
        </button>
        <button class="git-action-card danger" onclick="gitModalAction('clean')">
          <div class="git-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          </div>
          <div class="git-label">Force Clean</div>
          <div class="git-desc">git clean -fd</div>
        </button>
      </div>
      <div id="git-history-panel" style="display:none;margin-top:16px;">
        <div class="wt-section-label">Recent Commits</div>
        <div id="git-history-list"></div>
      </div>
      <div id="git-branches-panel" style="display:none;margin-top:16px;">
        <div class="wt-section-label">Branches</div>
        <div id="git-branches-list"></div>
      </div>
      <div id="git-result-panel" style="display:none;margin-top:16px;">
        <div class="wt-section-label">Result</div>
        <pre id="git-result-output" style="background:var(--surface2);padding:12px;border-radius:8px;font-size:0.7rem;max-height:200px;overflow:auto;"></pre>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ STATS MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="stats-overlay" onclick="handleStatsOverlayClick(event)">
  <div class="wt-modal" id="stats-modal" style="width: 680px;">
    <div class="modal-header">
      <div class="modal-title-wrap">
        <div class="modal-icon" style="background: linear-gradient(135deg, rgba(79,142,247,0.3), rgba(62,207,142,0.3));">üìä</div>
        <div>
          <div class="modal-title">Activity Stats</div>
          <div class="modal-subtitle">Last 7 days</div>
        </div>
      </div>
      <button class="modal-close" onclick="closeStatsModal()">‚úï</button>
    </div>
    <div class="modal-body" id="stats-modal-body">
      <div class="stats-loading"><div class="spinner"></div> loading stats‚Ä¶</div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ SCRATCHPAD MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="scratchpad-overlay" onclick="if(event.target===this)closeScratchpad()">
  <div class="scratchpad-modal">
    <div class="scratchpad-header">
      <h3>üìù Scratchpad ‚Äî <span id="scratchpad-repo-name"></span></h3>
      <button onclick="closeScratchpad()" class="close-btn">√ó</button>
    </div>
    <textarea id="scratchpad-textarea" placeholder="Quick notes about this repo..."></textarea>
    <div class="scratchpad-footer">
      <button onclick="saveScratchpad()" class="action-btn primary">Save</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ README PANEL ‚îÄ‚îÄ -->
<div id="backdrop" onclick="closePanel()"></div>
<div id="readme-panel">
  <div class="panel-header">
    <div class="panel-title" id="panel-title">README.md</div>
    <button id="panel-close" onclick="closePanel()">‚úï</button>
  </div>
  <div id="readme-content"></div>
</div>

<div id="toast"></div>

<script>
const API = 'http://127.0.0.1:8000';
let allProjects = [];
let activeFilter = 'all';
let wtRepoName = '';      // which repo the modal is open for
let wtData = [];          // cached worktree list for modal
let confirmMode = null;   // 'remove' | 'merge' | null
let confirmTarget = null; // the worktree object being actioned
let gitRepoName = '';      // which repo the git modal is open for

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadProjects() {
  // Clear file cache so hover data is fresh
  Object.keys(fileCache).forEach(k => delete fileCache[k]);
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('spinning');
  document.getElementById('grid').innerHTML = `<div class="loading"><div class="spinner"></div> loading repos‚Ä¶</div>`;
  try {
    const res = await fetch(`${API}/projects`);
    const data = await res.json();
    allProjects = data.projects;
    updateStats();
    renderGrid();
  } catch (e) {
    document.getElementById('grid').innerHTML = `<div class="empty">‚ö† Cannot reach backend ‚Äî is uvicorn running?</div>`;
  } finally {
    btn.classList.remove('spinning');
  }
}

function updateStats() {
  const dirty = allProjects.filter(p => p.git?.is_dirty).length;
  const wtCount = allProjects.reduce((acc, p) => acc + (p.git?.worktrees?.length || 0), 0);
  document.getElementById('stat-total').textContent = allProjects.length;
  document.getElementById('stat-dirty').textContent = dirty;
  document.getElementById('stat-wt').textContent = wtCount;
}

function renderGrid() {
  const query = document.getElementById('search').value.toLowerCase();
  let projects = allProjects.filter(p => p.name.toLowerCase().includes(query));
  if (activeFilter === 'dirty')     projects = projects.filter(p => p.git?.is_dirty);
  if (activeFilter === 'clean')     projects = projects.filter(p => p.git && !p.git.is_dirty);
  if (activeFilter === 'worktrees') projects = projects.filter(p => (p.git?.worktrees?.length || 0) > 1);
  if (activeFilter === 'nogit')     projects = projects.filter(p => !p.git);

  const grid = document.getElementById('grid');
  if (!projects.length) { grid.innerHTML = `<div class="empty">no repos match</div>`; return; }
  grid.innerHTML = projects.map((p, i) => buildCard(p, i)).join('');
  // Load saved commands into all rendered cards
  setTimeout(loadAllCmds, 50);
}

function buildCard(p, i) {
  const g = p.git;
  const statusClass = !g ? 'status-nogit' : (g.is_dirty ? 'status-dirty' : 'status-clean');
  const delay = Math.min(i * 35, 380);

  let badges = '';
  if (g) {
    badges += `<span class="badge badge-branch">‚éá ${esc(g.branch)}</span>`;
    if (g.is_dirty) badges += `<span class="badge badge-dirty">‚óè dirty</span>`;
    else            badges += `<span class="badge badge-clean">‚úì clean</span>`;
    if (g.ahead  > 0) badges += `<span class="badge badge-ahead">‚Üë${g.ahead}</span>`;
    if (g.behind > 0) badges += `<span class="badge badge-behind">‚Üì${g.behind}</span>`;
    if (g.stash_count > 0) badges += `<span class="badge badge-stash">stash:${g.stash_count}</span>`;
  }

  let commitLine = g?.last_msg ? `
    <div class="commit-line" id="cline-${esc(p.name)}">
      <span class="commit-hash">${esc(g.last_hash)}</span>
      <span class="commit-msg recent-files-trigger"
            onmouseenter="showRecentFiles(event,'${eA(p.name)}')"
            onmouseleave="scheduleHideTooltip('${eA(p.name)}')"
            title="Hover to see recently changed files">
        ${esc(g.last_msg)}
      </span>
      <span class="commit-time">${esc(g.last_time)}</span>
      <div class="files-tooltip" id="ftip-${esc(p.name)}"
           onmouseenter="cancelHideTooltip('${eA(p.name)}')"
           onmouseleave="scheduleHideTooltip('${eA(p.name)}')">
        <div class="tooltip-header">recently changed files (last commit)</div>
        <div class="tooltip-loading"><div class="spinner" style="width:12px;height:12px;border-width:1.5px"></div> loading‚Ä¶</div>
      </div>
    </div>` : '';

  let diffStats = '';
  if (g?.is_dirty) {
    diffStats = `<div class="diff-stats">`;
    if (g.staged   > 0) diffStats += `<div class="diff-item diff-staged"><div class="diff-dot"></div><span class="diff-label">staged</span><span class="diff-count">${g.staged}</span></div>`;
    if (g.unstaged > 0) diffStats += `<div class="diff-item diff-unstaged"><div class="diff-dot"></div><span class="diff-label">modified</span><span class="diff-count">${g.unstaged}</span></div>`;
    if (g.untracked> 0) diffStats += `<div class="diff-item diff-untracked"><div class="diff-dot"></div><span class="diff-label">untracked</span><span class="diff-count">${g.untracked}</span></div>`;
    diffStats += `</div>`;
  }

  // Compact worktree preview (max 3, excluding main)
  let wtPreview = '';
  const wts = (g?.worktrees || []).filter(w => !w.is_main);
  if (wts.length > 0) {
    const shown = wts.slice(0, 3);
    const statusKey = s => s.replace(' ', '-');
    const rows = shown.map(w => {
      const sk = statusKey(w.status || 'NA');
      return `<div class="wt-preview-row">
        <div class="wt-status-dot wt-s-${sk}"></div>
        <span class="wt-preview-branch">${esc(w.branch || '(detached)')}</span>
        <span style="color:var(--muted);margin-left:auto;font-size:0.6rem">${esc(w.age)}</span>
      </div>`;
    }).join('');
    const more = wts.length > 3 ? `<div class="wt-more">+${wts.length - 3} more</div>` : '';
    wtPreview = `<div class="wt-preview">${rows}${more}</div>`;
  }

  const hasGit = !!g;
  const cmdsHtml = `
    <div class="commands-section" id="cmds-${esc(p.name)}">
      <div class="commands-header">
        <span class="commands-label">‚ö° commands</span>
        <button class="cmd-edit-toggle" onclick="toggleCmdEdit('${eA(p.name)}')">edit</button>
      </div>
      <div class="cmd-run-list" id="cmdlist-${esc(p.name)}">
        <div style="font-family:var(--mono);font-size:0.62rem;color:var(--muted);padding:2px 0">
          no commands ‚Äî click edit to add
        </div>
      </div>
      <div class="cmd-edit-area" id="cmdedit-${esc(p.name)}" style="display:none"></div>
      <div class="cmd-output-panel" id="cmdout-${esc(p.name)}">
        <div class="cmd-output-header">
          <span id="cmdout-label-${esc(p.name)}">output</span>
          <button class="cmd-output-close" onclick="closeCmdOutput('${eA(p.name)}')">‚úï</button>
        </div>
        <div class="cmd-output-body" id="cmdout-body-${esc(p.name)}"></div>
      </div>
    </div>`;
  return `
    <div class="card ${statusClass}" style="animation-delay:${delay}ms">
      <div class="card-status-bar"></div>
      <div class="card-body">
        <div class="card-top">
          <div class="repo-name">${esc(p.name)}</div>
          <div class="badge-row">${badges}</div>
        </div>
        ${commitLine}
        ${diffStats}
        ${wtPreview}
        ${cmdsHtml}
        <div class="card-actions">
          <button class="action-btn primary" onclick="openVSCode('${eA(p.name)}')">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
            VS Code
          </button>
          <button class="action-btn" onclick="openTerminal('${eA(p.name)}')">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
            Terminal
          </button>
          <button class="action-btn" onclick="viewReadme('${eA(p.name)}')">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            README
          </button>
          ${hasGit ? `
          <button class="action-btn wt-btn" onclick="openWTModal('${eA(p.name)}')">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><line x1="12" y1="2" x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="4.22" y1="4.22" x2="6.34" y2="6.34"/><line x1="17.66" y1="17.66" x2="19.78" y2="19.78"/><line x1="2" y1="12" x2="5" y2="12"/><line x1="19" y1="12" x2="22" y2="12"/><line x1="4.22" y1="19.78" x2="6.34" y2="17.66"/><line x1="17.66" y1="6.34" x2="19.78" y2="4.22"/></svg>
            Worktrees
          </button>
          <button class="action-btn git-btn" onclick="openGitModal('${eA(p.name)}')">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7"/><line x1="6" y1="9" x2="6" y2="21"/></svg>
            git
          </button>` : ''}
        </div>
        <div class="card-icon-row">
          <div class="card-icon-wrapper" title="Notes">
            <button class="card-icon-btn notes-icon" onclick="openScratchpad('${eA(p.name)}')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </button>
            ${p.hasScratchpad ? '<div class="scratchpad-dot"></div>' : ''}
          </div>
        </div>
      </div>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKTREE MANAGER MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openWTModal(repoName) {
  wtRepoName = repoName;
  confirmMode = null;
  confirmTarget = null;
  document.getElementById('wt-modal-title').textContent = repoName;
  document.getElementById('wt-modal-sub').textContent = 'worktree manager';
  document.getElementById('wt-modal-body').innerHTML = `<div class="wt-loading"><div class="spinner"></div> loading‚Ä¶</div>`;
  document.getElementById('wt-overlay').classList.add('open');
  await refreshWTModal();
}

function closeWTModal() {
  document.getElementById('wt-overlay').classList.remove('open');
  wtRepoName = '';
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('wt-overlay')) closeWTModal();
}

async function refreshWTModal() {
  const [listRes, suffixRes] = await Promise.all([
    fetch(`${API}/wt/${encodeURIComponent(wtRepoName)}/list`),
    fetch(`${API}/wt/${encodeURIComponent(wtRepoName)}/default-suffix`),
  ]);
  const listData   = await listRes.json();
  const suffixData = await suffixRes.json();

  wtData = listData.worktrees || [];
  const currentBranch = listData.current_branch || '';
  const defaultSuffix = suffixData.suffix || '';

  document.getElementById('wt-modal-sub').textContent = `on ${currentBranch} ¬∑ ${wtData.length} worktree(s)`;
  renderWTModal(currentBranch, defaultSuffix);
}

function renderWTModal(currentBranch, defaultSuffix) {
  const main = wtData.find(w => w.is_main);
  const mainSha = main?.branch_sha || '';

  const contextBar = `
    <div class="context-bar">
      <span class="context-label">current branch</span>
      <span class="context-branch">‚éá ${esc(currentBranch)}</span>
      ${mainSha ? `<span class="context-sha">(${esc(mainSha)})</span>` : ''}
      <span style="margin-left:auto;color:var(--muted);font-size:0.65rem">Merge status compares each worktree against this branch</span>
    </div>`;

  const createSection = `
    <div class="create-section">
      <div class="create-header">‚ûï New Worktree</div>
      <div class="create-row">
        <input class="create-input" id="wt-new-name" type="text" value="${esc(defaultSuffix)}" placeholder="branch-name-suffix">
        <button class="create-btn" id="wt-create-btn" onclick="createWorktree()">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Create
        </button>
      </div>
      <div class="create-hint">Creates a new branch + worktree at <code>../${defaultSuffix || 'branch-name'}</code> from <strong style="color:var(--text)">${esc(currentBranch)}</strong></div>
    </div>`;

  const linked = wtData.filter(w => !w.is_main);
  let tableHtml = '';
  if (linked.length === 0) {
    tableHtml = `<div class="wt-empty">No linked worktrees. Create one above.</div>`;
  } else {
    const statusKey = s => (s || 'NA').replace(' ', '-');
    const rows = linked.map((wt, i) => {
      const sk     = statusKey(wt.status);
      const pathShort = (wt.path || '').replace(/\\/g, '/').split('/').slice(-2).join('/');
      const notMergedWarn = wt.status === 'NOT MERGED'
        ? `<span style="color:var(--yellow);margin-left:4px" title="Has unmerged commits">‚ö†</span>` : '';
      return `
        <tr class="wt-row">
          <td class="wt-cell wt-cell-branch">${esc(wt.branch || '(detached)')}${notMergedWarn}</td>
          <td class="wt-cell">
            <span class="wt-status s-${sk}">
              <span class="wt-status-dot-sm dot-${sk}"></span>
              ${esc(wt.status || 'N/A')}
            </span>
          </td>
          <td class="wt-cell wt-cell-sha">${esc(wt.branch_sha)}</td>
          <td class="wt-cell wt-cell-path" title="${esc(wt.path)}">‚Ä¶/${esc(pathShort)}</td>
          <td class="wt-cell wt-cell-age">${esc(wt.age)}</td>
          <td class="wt-cell">
            <div class="wt-actions-cell">
              <button class="wt-action wt-open"  onclick="wtOpen('${eA(wt.path)}')">open</button>
              ${wt.branch ? `<button class="wt-action wt-merge" onclick="wtShowMerge(${i})">merge</button>` : ''}
              <button class="wt-action wt-del"   onclick="wtShowRemove(${i})">remove</button>
            </div>
          </td>
        </tr>`;
    }).join('');

    tableHtml = `
      <div class="wt-section-label">Linked Worktrees (${linked.length})</div>
      <table class="wt-table">
        <thead>
          <tr>
            <th>Branch</th>
            <th>Status</th>
            <th>SHA</th>
            <th>Path</th>
            <th>Age</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
  }

  document.getElementById('wt-modal-body').innerHTML =
    contextBar + createSection + tableHtml + `<div id="confirm-area"></div>`;
}

// ‚îÄ‚îÄ CREATE ‚îÄ‚îÄ
async function createWorktree() {
  const input = document.getElementById('wt-new-name');
  const btn   = document.getElementById('wt-create-btn');
  const suffix = input?.value?.trim();
  if (!suffix) { toast('Enter a branch name', 'err'); return; }

  btn.disabled = true;
  btn.textContent = 'Creating‚Ä¶';
  try {
    const res  = await fetch(`${API}/wt/${encodeURIComponent(wtRepoName)}/create`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ suffix }),
    });
    const data = await res.json();
    if (data.success) {
      toast(`‚úì Worktree '${suffix}' created`, 'ok');
      await refreshWTModal();
      loadProjects();
    } else {
      toast(`‚úó ${data.output || data.detail || 'Unknown error'}`, 'err');
      btn.disabled = false;
      btn.innerHTML = `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Create`;
    }
  } catch (e) {
    toast(`‚úó Cannot reach server: ${e.message}`, 'err');
    btn.disabled = false;
    btn.innerHTML = `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Create`;
  }
}

// ‚îÄ‚îÄ OPEN ‚îÄ‚îÄ
async function wtOpen(path) {
  await fetch(`${API}/open-worktree?path=${encodeURIComponent(path)}`);
  toast('Opened in VS Code', 'ok');
}

// ‚îÄ‚îÄ REMOVE CONFIRM ‚îÄ‚îÄ
function wtShowRemove(idx) {
  const linked = wtData.filter(w => !w.is_main);
  const wt = linked[idx];
  if (!wt) return;
  confirmMode   = 'remove';
  confirmTarget = wt;

  const notMergedWarn = wt.status === 'NOT MERGED'
    ? `<div class="confirm-warn">‚ö† This worktree has unmerged commits ‚Äî they will be lost if you delete the branch.</div>` : '';

  document.getElementById('confirm-area').innerHTML = `
    <div class="confirm-panel" id="confirm-panel">
      <div class="confirm-title">üóë Remove Worktree</div>
      <div class="confirm-detail">
        Branch: <strong>${esc(wt.branch || '(detached)')}</strong><br>
        Path: <strong>${esc(wt.path)}</strong><br>
        Status: <strong style="color:var(--${statusColor(wt.status)})">${esc(wt.status)}</strong>
      </div>
      ${notMergedWarn}
      <label class="checkbox-row">
        <input type="checkbox" id="del-branch-check">
        Also delete the branch <strong style="color:var(--text)">${esc(wt.branch || '')}</strong>
      </label>
      <div class="confirm-btns">
        <button class="btn-confirm btn-cancel" onclick="clearConfirm()">Cancel</button>
        <button class="btn-confirm btn-danger" onclick="doRemove()">Remove</button>
      </div>
    </div>`;

  document.getElementById('confirm-panel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

async function doRemove() {
  const wt = confirmTarget;
  const deleteBranch = document.getElementById('del-branch-check')?.checked || false;
  clearConfirm();
  toast('Removing worktree‚Ä¶');

  const res  = await fetch(`${API}/wt/${encodeURIComponent(wtRepoName)}/remove`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      worktree_path: wt.path,
      branch: wt.branch,
      delete_branch: deleteBranch,
    }),
  });
  const data = await res.json();
  if (data.success) {
    toast(`‚úì Removed ${wt.branch || wt.path}`, 'ok');
    await refreshWTModal();
    loadProjects();
  } else {
    toast(`‚úó ${data.output}`, 'err');
  }
}

// ‚îÄ‚îÄ MERGE CONFIRM ‚îÄ‚îÄ
function wtShowMerge(idx) {
  const linked = wtData.filter(w => !w.is_main);
  const wt = linked[idx];
  if (!wt) return;
  confirmMode   = 'merge';
  confirmTarget = wt;

  const main = wtData.find(w => w.is_main);
  const currentBranch = wt.parent_branch || main?.branch || '?';

  document.getElementById('confirm-area').innerHTML = `
    <div class="confirm-panel" id="confirm-panel">
      <div class="confirm-title">‚éá Merge Worktree</div>
      <div class="confirm-detail">
        Merge <strong>${esc(wt.branch)}</strong> into <strong style="color:var(--green)">${esc(currentBranch)}</strong><br>
        SHA: <strong>${esc(wt.branch_sha)}</strong> ¬∑ Status: <strong style="color:var(--${statusColor(wt.status)})">${esc(wt.status)}</strong>
      </div>
      <label class="checkbox-row">
        <input type="checkbox" id="cleanup-check" checked>
        Remove worktree after merge
      </label>
      <label class="checkbox-row">
        <input type="checkbox" id="del-branch-merge-check" checked>
        Delete branch <strong style="color:var(--text)">${esc(wt.branch)}</strong> after merge
      </label>
      <div class="confirm-btns">
        <button class="btn-confirm btn-cancel" onclick="clearConfirm()">Cancel</button>
        <button class="btn-confirm btn-success" onclick="doMerge()">Merge</button>
      </div>
    </div>`;

  document.getElementById('confirm-panel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

async function doMerge() {
  const wt = confirmTarget;
  const cleanup     = document.getElementById('cleanup-check')?.checked ?? true;
  const deleteBranch= document.getElementById('del-branch-merge-check')?.checked ?? true;
  clearConfirm();
  toast('Merging‚Ä¶');

  const res  = await fetch(`${API}/wt/${encodeURIComponent(wtRepoName)}/merge`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      branch: wt.branch,
      worktree_path: wt.path,
      cleanup,
      delete_branch: deleteBranch,
    }),
  });
  const data = await res.json();
  if (data.success) {
    const into = data.merged_into || '';
    toast(`‚úì Merged ${wt.branch} ‚Üí ${into}`, 'ok');
    await refreshWTModal();
    loadProjects();
  } else {
    toast(`‚úó ${data.output}`, 'err');
  }
}

function clearConfirm() {
  document.getElementById('confirm-area').innerHTML = '';
  confirmMode = null;
  confirmTarget = null;
}

function statusColor(s) {
  const map = { 'FRESH': 'cyan', 'MERGED': 'green', 'NOT MERGED': 'yellow', 'DETACHED': 'red' };
  return map[s] || 'muted';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECENT FILES TOOLTIP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const fileCache = {};       // repoName -> files array
const tooltipHideTimers = {}; // repoName -> timer id

async function showRecentFiles(e, name) {
  cancelHideTooltip(name);
  const tip = document.getElementById(`ftip-${name}`);
  if (!tip) return;
  tip.classList.add('visible');

  if (fileCache[name]) {
    renderFilesTooltip(name, fileCache[name]);
    return;
  }

  try {
    const res = await fetch(`${API}/git/${encodeURIComponent(name)}/recent-files`);
    const data = await res.json();
    fileCache[name] = data.files || [];
    renderFilesTooltip(name, fileCache[name]);
  } catch {
    const tip = document.getElementById(`ftip-${name}`);
    if (tip) tip.innerHTML = `<div class="tooltip-loading" style="color:var(--red)">failed to load</div>`;
  }
}

function renderFilesTooltip(name, files) {
  const tip = document.getElementById(`ftip-${name}`);
  if (!tip) return;
  if (!files.length) {
    tip.innerHTML = `<div class="tooltip-header">recently changed files</div><div class="tooltip-loading">no changes found</div>`;
    return;
  }
  const statusLabel = { M: 'M', A: 'A', D: 'D', R: 'R' };
  const rows = files.map(f => {
    const parts = f.path.replace(/\\/g, '/').split('/');
    const fname = parts.pop();
    const dir   = parts.length ? parts.join('/') + '/' : '';
    const s     = f.status || '?';
    return `<div class="file-row">
      <div class="file-status fs-${s}">${statusLabel[s] || s}</div>
      <span class="file-path"><span class="file-dir">${esc(dir)}</span>${esc(fname)}</span>
    </div>`;
  }).join('');
  tip.innerHTML = `<div class="tooltip-header">recently changed files (last commit)</div>${rows}`;
}

function scheduleHideTooltip(name) {
  tooltipHideTimers[name] = setTimeout(() => {
    const tip = document.getElementById(`ftip-${name}`);
    if (tip) tip.classList.remove('visible');
  }, 180);
}

function cancelHideTooltip(name) {
  clearTimeout(tooltipHideTimers[name]);
}

// Clear cache on refresh so stale data doesn't linger
const _origLoadProjects = loadProjects;


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMMANDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const cmdState = {};  // repoName -> { commands: [], editing: bool }

async function initCmds(name) {
  if (cmdState[name]) { renderCmds(name); return; }
  try {
    const res = await fetch(`${API}/commands/${encodeURIComponent(name)}`);
    const data = await res.json();
    cmdState[name] = { commands: data.commands || [], editing: false };
    renderCmds(name);
  } catch { /* ignore */ }
}

function renderCmds(name) {
  const state = cmdState[name];
  if (!state) return;
  const listEl = document.getElementById(`cmdlist-${name}`);
  const editEl = document.getElementById(`cmdedit-${name}`);
  if (!listEl || !editEl) return;

  if (!state.editing) {
    editEl.style.display = 'none';
    if (!state.commands.length) {
      listEl.innerHTML = `<div style="font-family:var(--mono);font-size:0.62rem;color:var(--muted);padding:2px 0">no commands ‚Äî click edit to add</div>`;
    } else {
      listEl.innerHTML = state.commands.map((c, i) => `
        <div class="cmd-run-row">
          <button class="cmd-run-btn" id="cmdbtn-${esc(name)}-${i}" onclick="runCmd('${eA(name)}',${i})">
            <svg class="cmd-play" width="9" height="9" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>
            <span class="cmd-label">${esc(c.label)}</span>
            <span class="cmd-shell">${esc(c.cmd)}</span>
          </button>
        </div>`).join('');
    }
  } else {
    listEl.innerHTML = '';
    const rows = state.commands.map((c, i) => `
      <div class="cmd-edit-row">
        <input class="cmd-input cmd-input-label" placeholder="label" value="${esc(c.label)}"
               oninput="cmdState['${eA(name)}'].commands[${i}].label=this.value">
        <input class="cmd-input cmd-input-cmd" placeholder="npm test" value="${esc(c.cmd)}"
               oninput="cmdState['${eA(name)}'].commands[${i}].cmd=this.value">
        <button class="cmd-del-btn" onclick="cmdDelete('${eA(name)}',${i})">‚úï</button>
      </div>`).join('');
    editEl.innerHTML = rows +
      `<button class="cmd-add-btn" onclick="cmdAdd('${eA(name)}')">+ add command</button>` +
      `<button class="cmd-save-btn" onclick="saveCmds('${eA(name)}')">save</button>`;
    editEl.style.display = 'block';
  }
}

function toggleCmdEdit(name) {
  if (!cmdState[name]) { initCmds(name); return; }
  cmdState[name].editing = !cmdState[name].editing;
  renderCmds(name);
}

function cmdAdd(name) {
  cmdState[name].commands.push({ label: '', cmd: '' });
  renderCmds(name);
}

function cmdDelete(name, idx) {
  cmdState[name].commands.splice(idx, 1);
  renderCmds(name);
}

async function saveCmds(name) {
  const cmds = cmdState[name].commands.filter(c => c.label && c.cmd);
  cmdState[name].commands = cmds;
  try {
    await fetch(`${API}/commands/${encodeURIComponent(name)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ commands: cmds }),
    });
    toast(`‚úì Commands saved for ${name}`, 'ok');
  } catch { toast('‚úó Failed to save', 'err'); }
  cmdState[name].editing = false;
  renderCmds(name);
}

async function runCmd(name, idx) {
  const state = cmdState[name];
  if (!state) return;
  const cmd = state.commands[idx];
  if (!cmd) return;

  const btn    = document.getElementById(`cmdbtn-${name}-${idx}`);
  const outEl  = document.getElementById(`cmdout-${name}`);
  const bodyEl = document.getElementById(`cmdout-body-${name}`);
  const lblEl  = document.getElementById(`cmdout-label-${name}`);

  if (btn) { btn.classList.add('running'); btn.disabled = true; }
  if (outEl) outEl.classList.add('visible');
  if (lblEl) lblEl.textContent = `$ ${cmd.cmd}`;
  if (bodyEl) bodyEl.textContent = 'running‚Ä¶';
  if (bodyEl) bodyEl.className = 'cmd-output-body';

  try {
    const res  = await fetch(`${API}/commands/${encodeURIComponent(name)}/run`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cmd: cmd.cmd }),
    });
    const data = await res.json();
    if (bodyEl) {
      bodyEl.textContent = data.output || '(no output)';
      bodyEl.className   = `cmd-output-body ${data.success ? 'cmd-output-ok' : 'cmd-output-err'}`;
    }
    toast(data.success ? `‚úì ${cmd.label}` : `‚úó ${cmd.label} failed`, data.success ? 'ok' : 'err');
  } catch (e) {
    if (bodyEl) { bodyEl.textContent = e.message; bodyEl.className = 'cmd-output-body cmd-output-err'; }
  } finally {
    if (btn) { btn.classList.remove('running'); btn.disabled = false; }
  }
}

function closeCmdOutput(name) {
  const el = document.getElementById(`cmdout-${name}`);
  if (el) el.classList.remove('visible');
}

// Load commands for all cards after grid renders
function loadAllCmds() {
  allProjects.forEach(p => { if (p.git) initCmds(p.name); });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARD ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openVSCode(name) {
  await fetch(`${API}/open/${name}`);
  toast(`Opening ${name} in VS Code`);
}

async function openTerminal(name) {
  await fetch(`${API}/open-terminal/${name}`);
  toast(`Opening terminal in ${name}`);
}

async function viewReadme(name) {
  document.getElementById('panel-title').textContent = `${name} / README.md`;
  document.getElementById('readme-content').innerHTML = `<div style="color:var(--muted);font-family:var(--mono);font-size:0.75rem;padding:20px">loading‚Ä¶</div>`;
  document.getElementById('readme-panel').classList.add('open');
  document.getElementById('backdrop').classList.add('show');
  const res  = await fetch(`${API}/readme/${name}`);
  const data = await res.json();
  document.getElementById('readme-content').innerHTML = renderMarkdown(data.content);
}

async function gitAction(name, action) {
  toast(`Running git ${action}‚Ä¶`);
  const res  = await fetch(`${API}/git/${name}/${action}`, { method: 'POST' });
  const data = await res.json();
  toast(
    data.success ? `‚úì ${(data.output || '').split('\n')[0] || 'Done'}` : `‚úó ${(data.output || '').split('\n')[0]}`,
    data.success ? 'ok' : 'err'
  );
  if (data.success) setTimeout(loadProjects, 800);
}

async function viewGitDetails(name) {
  // Open the panel and show a loading state
  document.getElementById('panel-title').textContent = `${name} / Git History`;
  document.getElementById('readme-content').innerHTML = `<div class="loading"><div class="spinner"></div> fetching git data‚Ä¶</div>`;
  document.getElementById('readme-panel').classList.add('open');
  document.getElementById('backdrop').classList.add('show');

  try {
    const res = await fetch(`${API}/git/${encodeURIComponent(name)}/details`);
    const data = await res.json();

    if (data.error) {
      document.getElementById('readme-content').innerHTML = `<p style="color:var(--red)">${data.error}</p>`;
      return;
    }

    // 1. Build the Branches HTML
    let branchHtml = `<h3>‚éá Branches</h3><div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:30px;">`;
    data.branches.forEach(b => {
      const isCurrent = b.startsWith('*');
      const bName = isCurrent ? b.substring(1).trim() : b;
      const style = isCurrent 
        ? `background:rgba(62,207,142,0.15); color:var(--green); border:1px solid rgba(62,207,142,0.3);` 
        : `background:var(--surface2); color:var(--text); border:1px solid var(--border);`;
      branchHtml += `<span style="padding:5px 10px; border-radius:6px; font-family:var(--mono); font-size:0.75rem; ${style}">${bName}</span>`;
    });
    branchHtml += `</div>`;

    // 2. Build the Commits HTML
    let commitHtml = `<h3>üìù Last 10 Commits</h3><div style="display:flex; flex-direction:column; gap:12px;">`;
    if (data.commits.length === 0) {
        commitHtml += `<div style="color:var(--muted); font-family:var(--mono); font-size:0.8rem;">No commits found.</div>`;
    } else {
        data.commits.forEach(c => {
          commitHtml += `
            <div style="background:var(--surface2); border:1px solid var(--border); padding:14px; border-radius:8px; transition: border-color 0.2s;">
              <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-family:var(--mono); font-size:0.75rem;">
                <span style="color:var(--accent); font-weight:bold;">${c.hash}</span>
                <span style="color:var(--muted)">${c.time}</span>
              </div>
              <div style="font-size:0.9rem; color:var(--text); margin-bottom:8px; line-height: 1.4;">${esc(c.message)}</div>
              <div style="font-size:0.75rem; color:var(--muted); font-family:var(--mono);">üë§ ${esc(c.author)}</div>
            </div>`;
        });
    }
    commitHtml += `</div>`;

    // Inject the final HTML into the panel
    document.getElementById('readme-content').innerHTML = branchHtml + commitHtml;

  } catch (e) {
    document.getElementById('readme-content').innerHTML = `<p style="color:var(--red)">Failed to reach backend.</p>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GIT ACTIONS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openGitModal(repoName) {
  gitRepoName = repoName;
  document.getElementById('git-modal-title').textContent = repoName;
  document.getElementById('git-modal-sub').textContent = 'git actions';
  document.getElementById('git-history-panel').style.display = 'none';
  document.getElementById('git-result-panel').style.display = 'none';
  document.getElementById('git-overlay').classList.add('open');
}

function closeGitModal() {
  document.getElementById('git-overlay').classList.remove('open');
  gitRepoName = '';
}

function handleGitOverlayClick(e) {
  if (e.target === document.getElementById('git-overlay')) closeGitModal();
}

async function gitModalAction(action) {
  const resultPanel = document.getElementById('git-result-panel');
  const resultOutput = document.getElementById('git-result-output');
  const historyPanel = document.getElementById('git-history-panel');
  const historyList = document.getElementById('git-history-list');
  const branchesPanel = document.getElementById('git-branches-panel');
  const branchesList = document.getElementById('git-branches-list');

  if (action === 'history') {
    // Show history panel
    historyPanel.style.display = 'block';
    resultPanel.style.display = 'none';
    branchesPanel.style.display = 'none';
    historyList.innerHTML = '<div class="wt-loading"><div class="spinner"></div> loading commits‚Ä¶</div>';

    try {
      const res = await fetch(`${API}/git/${encodeURIComponent(gitRepoName)}/log`);
      const data = await res.json();

      if (data.commits && data.commits.length > 0) {
        historyList.innerHTML = data.commits.map(c => `
          <div class="git-history-item">
            <span class="git-hash">${esc(c.hash)}</span>
            <span class="git-msg">${esc(c.message)}</span>
            <span class="git-meta">${esc(c.date)} ¬∑ ${esc(c.author)}</span>
          </div>
        `).join('');
      } else {
        historyList.innerHTML = '<div style="padding:12px;color:var(--muted);font-family:var(--mono);font-size:0.7rem;">No commits found</div>';
      }
    } catch (e) {
      historyList.innerHTML = `<div style="padding:12px;color:var(--red);font-family:var(--mono);font-size:0.7rem;">Failed to load history</div>`;
    }
  } else if (action === 'branches') {
    // Show branches panel
    branchesPanel.style.display = 'block';
    resultPanel.style.display = 'none';
    historyPanel.style.display = 'none';
    branchesList.innerHTML = '<div class="wt-loading"><div class="spinner"></div> loading branches‚Ä¶</div>';

    try {
      const res = await fetch(`${API}/git/${encodeURIComponent(gitRepoName)}/branches`);
      const data = await res.json();

      if (data.branches && data.branches.length > 0) {
        branchesList.innerHTML = data.branches.map(b => `
          <div class="git-history-item" style="${b.is_current ? 'background:rgba(62,207,142,0.08);' : ''}">
            <span class="git-hash" style="color:${b.is_current ? 'var(--green)' : 'var(--accent)'}">${b.is_current ? '*' : '‚ãÖ'}</span>
            <span class="git-msg" style="${b.is_current ? 'color:var(--green);font-weight:700;' : ''}">${esc(b.name)}</span>
            <span class="git-meta">${b.is_current ? 'current' : ''}</span>
          </div>
        `).join('');
      } else {
        branchesList.innerHTML = '<div style="padding:12px;color:var(--muted);font-family:var(--mono);font-size:0.7rem;">No branches found</div>';
      }
    } catch (e) {
      branchesList.innerHTML = `<div style="padding:12px;color:var(--red);font-family:var(--mono);font-size:0.7rem;">Failed to load branches</div>`;
    }
  } else {
    // Run git command
    historyPanel.style.display = 'none';
    branchesPanel.style.display = 'none';
    resultPanel.style.display = 'block';
    resultOutput.textContent = `Running git ${action}‚Ä¶`;

    const res = await fetch(`${API}/git/${gitRepoName}/${action}`, { method: 'POST' });
    const data = await res.json();

    resultOutput.textContent = data.output || (data.success ? 'Done!' : 'Failed');

    toast(
      data.success ? `‚úì git ${action} completed` : `‚úó git ${action} failed`,
      data.success ? 'ok' : 'err'
    );
    if (data.success) setTimeout(loadProjects, 800);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openStatsModal() {
  document.getElementById('stats-overlay').classList.add('open');
  loadStats();
}

function closeStatsModal() {
  document.getElementById('stats-overlay').classList.remove('open');
}

function handleStatsOverlayClick(e) {
  if (e.target === document.getElementById('stats-overlay')) closeStatsModal();
}

async function loadStats() {
  const modalBody = document.getElementById('stats-modal-body');
  modalBody.innerHTML = '<div class="stats-loading"><div class="spinner"></div> loading stats‚Ä¶</div>';

  try {
    const res = await fetch(`${API}/stats`);
    const data = await res.json();
    renderStats(data);
  } catch (e) {
    modalBody.innerHTML = '<div style="padding:20px;color:var(--red);font-family:var(--mono);font-size:0.75rem;">Failed to load stats</div>';
  }
}

function renderStats(data) {
  const modalBody = document.getElementById('stats-modal-body');
  let html = '';

  // ‚îÄ‚îÄ 1. Streak hero ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const isActive = (data.current_streak || 0) > 0;
  html += `
    <div class="streak-hero">
      <div class="streak-card ${isActive ? 'active' : ''}">
        <div class="streak-num">${data.current_streak || 0}</div>
        <div class="streak-label">Current streak</div>
        <div class="streak-sub">${isActive ? 'days in a row üî•' : 'no commits today yet'}</div>
      </div>
      <div class="streak-card">
        <div class="streak-num">${data.longest_streak || 0}</div>
        <div class="streak-label">Longest streak</div>
        <div class="streak-sub">${data.streak_start ? `${formatDate(data.streak_start)} ‚Äì ${formatDate(data.streak_end)}` : 'no history yet'}</div>
      </div>
    </div>`;

  // ‚îÄ‚îÄ 2. Uncommitted health bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const dirty = data.dirty_repos || 0;
  const totalFiles = (data.total_staged||0) + (data.total_modified||0) + (data.total_untracked||0);
  html += `
    <div class="health-bar">
      <div class="health-dot ${dirty > 0 ? 'warn' : 'ok'}"></div>
      <span class="health-text">${dirty > 0
        ? `<strong style="color:var(--yellow)">${dirty} repo${dirty>1?'s':''}</strong> with uncommitted work`
        : 'All repos clean'}</span>
      ${dirty > 0 ? `<span class="health-detail">${data.total_staged||0} staged ¬∑ ${data.total_modified||0} modified ¬∑ ${data.total_untracked||0} untracked</span>` : ''}
    </div>`;

  // ‚îÄ‚îÄ 3. Key insights ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  html += `
    <div class="stats-section">
      <div class="stats-section-title">üìä insights ¬∑ last ${data.days_period} days</div>
      <div class="insight-row">
        <span class="insight-label">Total commits</span>
        <span class="insight-value insight-highlight">${data.total_commits || 0}</span>
      </div>
      <div class="insight-row">
        <span class="insight-label">Most active day</span>
        <span class="insight-value">${data.most_active_day}${data.most_active_percentage ? ` <span style="color:var(--muted);font-size:0.65rem">(${data.most_active_percentage}%)</span>` : ''}</span>
      </div>
      <div class="insight-row">
        <span class="insight-label">Last commit</span>
        <span class="insight-value">${data.latest_commit || 'none'} ${data.latest_commit_repo ? `<span style="color:var(--muted)">in</span> <span style="color:var(--accent)">${esc(data.latest_commit_repo)}</span>` : ''}</span>
      </div>
    </div>`;

  // ‚îÄ‚îÄ 4. This week vs last week ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (data.this_week && data.last_week) {
    const maxVal = Math.max(...data.this_week, ...data.last_week, 1);
    const pxMax  = 52;
    const labels = data.week_labels || ['M','T','W','T','F','S','S'];
    html += `
      <div class="stats-section">
        <div class="stats-section-title">üìÖ this week vs last week</div>
        <div class="week-chart-wrap">
          <div class="week-legend">
            <span><span class="legend-swatch" style="background:var(--accent)"></span>this week</span>
            <span><span class="legend-swatch" style="background:var(--border2)"></span>last week</span>
          </div>
          <div class="week-chart">
            ${data.this_week.map((tw, i) => {
              const lw = data.last_week[i];
              const twH = Math.round((tw / maxVal) * pxMax);
              const lwH = Math.round((lw / maxVal) * pxMax);
              return `<div class="week-col">
                <div class="week-bars">
                  <div class="week-bar last" style="height:${Math.max(lwH,2)}px" data-tip="last: ${lw}"></div>
                  <div class="week-bar this" style="height:${Math.max(twH,2)}px" data-tip="this: ${tw}"></div>
                </div>
                <div class="week-day-label">${labels[i]}</div>
              </div>`;
            }).join('')}
          </div>
        </div>
      </div>`;
  }

  // ‚îÄ‚îÄ 5. Hour-of-day heatmap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (data.hour_distribution) {
    const maxH = Math.max(...data.hour_distribution.map(h => h.count), 1);
    html += `
      <div class="stats-section">
        <div class="stats-section-title">üïê when you commit (hour of day)</div>
        <div class="hour-wrap">
          <div class="hour-grid">
            ${data.hour_distribution.map(h => {
              const intensity = h.count / maxH;
              const alpha     = h.count === 0 ? 0.06 : 0.15 + intensity * 0.85;
              const label     = h.hour === 0 ? '12a' : h.hour < 12 ? `${h.hour}a` : h.hour === 12 ? '12p' : `${h.hour-12}p`;
              return `<div class="hour-cell"
                style="background:rgba(79,142,247,${alpha.toFixed(2)})"
                data-tip="${label}: ${h.count} commit${h.count!==1?'s':''}"></div>`;
            }).join('')}
          </div>
          <div class="hour-labels">
            ${data.hour_distribution.map(h => {
              const show = h.hour % 3 === 0;
              const label = h.hour === 0 ? '12a' : h.hour < 12 ? `${h.hour}a` : h.hour === 12 ? '12p' : `${h.hour-12}p`;
              return `<div class="hour-label">${show ? label : ''}</div>`;
            }).join('')}
          </div>
        </div>
      </div>`;
  }

  // ‚îÄ‚îÄ 6. Top repos with sparklines ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  html += `<div class="stats-section"><div class="stats-section-title">üèÜ top repos ¬∑ last ${data.days_period} days</div>`;
  if (data.top_repos && data.top_repos.length > 0) {
    const maxC = data.top_repos[0].commits;
    html += data.top_repos.map((repo, i) => {
      const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `<span style="color:var(--muted);font-family:var(--mono);font-size:0.65rem">${i+1}</span>`;
      const barW  = Math.round((repo.commits / maxC) * 100);
      const maxSpark = Math.max(...(repo.spark||[]), 1);
      const sparkHtml = (repo.spark||[]).map(v => {
        const h = Math.max(Math.round((v/maxSpark)*14), v>0?3:2);
        return `<div class="spark-b ${v>0?'on':'off'}" style="height:${h}px"></div>`;
      }).join('');
      return `
        <div class="activity-item">
          <div class="activity-main">
            <span style="font-size:0.85rem;min-width:20px">${medal}</span>
            <span class="activity-name">${esc(repo.name)}</span>
            <div class="activity-bar-wrap">
              <div class="activity-bar"><div class="activity-bar-fill" style="width:${barW}%"></div></div>
              <span class="activity-count">${repo.commits}</span>
            </div>
          </div>
          ${repo.spark ? `<div class="repo-spark">${sparkHtml}</div>` : ''}
        </div>`;
    }).join('');
  } else {
    html += `<div style="padding:12px;color:var(--muted);font-family:var(--mono);font-size:0.7rem">No commits in the last ${data.days_period} days</div>`;
  }
  html += '</div>';

  modalBody.innerHTML = html;
}

function formatDate(isoDate) {
  if (!isoDate) return '';
  const d = new Date(isoDate);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function closePanel() {
  document.getElementById('readme-panel').classList.remove('open');
  document.getElementById('backdrop').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function toast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = type ? `show ${type}` : 'show';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.className = '', 2800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARKDOWN RENDERER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMarkdown(md) {
  if (!md) return '';
  const e = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  let h = e(md);
  h = h.replace(/```[\w]*\n([\s\S]*?)```/g, (_, c) => `<pre><code>${c.trimEnd()}</code></pre>`);
  h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
  h = h.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  h = h.replace(/^## (.+)$/gm,  '<h2>$1</h2>');
  h = h.replace(/^# (.+)$/gm,   '<h1>$1</h1>');
  h = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  h = h.replace(/\*(.+?)\*/g,     '<em>$1</em>');
  h = h.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
  h = h.replace(/^---$/gm, '<hr>');
  h = h.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
  h = h.replace(/(<li>.*<\/li>\n?)+/g, m => `<ul>${m}</ul>`);
  h = h.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');
  h = h.split(/\n{2,}/).map(b =>
    /^<(h[1-6]|ul|pre|blockquote|hr)/.test(b.trim()) ? b : `<p>${b.replace(/\n/g,' ')}</p>`
  ).join('\n');
  return h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCRATCHPAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openScratchpad(name) {
  const repo = document.getElementById('scratchpad-repo-name');
  const textarea = document.getElementById('scratchpad-textarea');
  repo.textContent = name;
  const res = await fetch(`${API}/repo/${encodeURIComponent(name)}/scratchpad`);
  const data = await res.json();
  textarea.value = data.content || '';
  textarea.dataset.repoName = name;
  document.getElementById('scratchpad-overlay').classList.add('open');
}

async function saveScratchpad() {
  const textarea = document.getElementById('scratchpad-textarea');
  const name = textarea.dataset.repoName;
  await fetch(`${API}/repo/${encodeURIComponent(name)}/scratchpad`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ content: textarea.value })
  });
  toast('Scratchpad saved');
  closeScratchpad();
  loadProjects(); // Refresh to show indicator
}

function closeScratchpad() {
  document.getElementById('scratchpad-overlay').classList.remove('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTEXT CAPTURE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s)  { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function eA(s)   { return String(s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('search').addEventListener('input', renderGrid);

document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeFilter = btn.dataset.filter;
    renderGrid();
  });
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    if (document.getElementById('wt-overlay').classList.contains('open')) {
      if (confirmMode) clearConfirm();
      else closeWTModal();
    } else if (document.getElementById('git-overlay').classList.contains('open')) {
      closeGitModal();
    } else if (document.getElementById('stats-overlay').classList.contains('open')) {
      closeStatsModal();
    } else if (document.getElementById('scratchpad-overlay').classList.contains('open')) {
      closeScratchpad();
    } else {
      closePanel();
    }
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 'r') { e.preventDefault(); loadProjects(); }
});

loadProjects();
</script>
</body>
</html>